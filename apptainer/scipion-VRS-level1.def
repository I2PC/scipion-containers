Bootstrap: localimage
From: scipion-VRS-level0.sif

%labels
  Maintainer1 miceta@cnb.csic.es
  Maintainer2 md.sanchez@cnb.csic.es
  Maintainer3 isanchez@cnb.csic.es
 # version 24.02.1

%help
  VRS level 1 package add-on for Apptainer/Singularity VRS level 0 image

%post
    # Export tz for apt so it does not block on install
    export TZ=UTC
    export DEBIAN_FRONTEND=noninteractive
    # Add cuda lib to path
    export LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH"

    # Lets you know if cuda is OK
    which nvcc
    ls -l /dev/nvidia*

    # Dependencies
    apt update

    git clone -b devel https://github.com/scipion-em/scipion-em-spoc.git /scipion/scipion-em-spoc
    /scipion/scipion3 installp -p /scipion/scipion-em-spoc --devel

    /scipion/scipion3 installp -p scipion-em-bsoft

    /scipion/scipion3 installp -p scipion-em-resmap

    /scipion/scipion3 installp -p scipion-em-fsc3d 3.2.2

    rm -rf /scipion/scipion-em-validation
    git clone -b apptainer https://github.com/I2PC/scipion-em-validation /scipion/scipion-em-validation
    /scipion/scipion3 pip install -r /scipion/scipion-em-validation/requirements.txt

    # Cleaning tasks for space optimisation
    apt clean
    apt autoclean
    apt autoremove
    rm -rf /var/lib/apt/lists/*
    unset DEBIAN_FRONTEND

%runscript