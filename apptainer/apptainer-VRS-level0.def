Bootstrap: localimage
From: scipion-base.sif

%labels
  Maintainer1 miceta@cnb.csic.es
  Maintainer2 md.sanchez@cnb.csic.es
  Maintainer3 isanchez@cnb.csic.es
 # version 24.02.1

%help
  VRS level 0 package add-on for Apptainer/Singularity base image

%post
    # Export tz for apt so it does not block on install
    export TZ=UTC
    export DEBIAN_FRONTEND=noninteractive
    # Add cuda lib to path
    export LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH"

    # Lets you know if cuda is OK
    which nvcc
    ls -l /dev/nvidia*

    # Dependencies
    apt-get update
    # needed libraries
    # pdflatex
    apt-get install -y texlive-latex-extra

    # deepLearningToolkit
    export CONDA_OVERRIDE_CUDA=11.8
    /scipion/scipion3 installb deepLearningToolkit

    git clone https://gitlab.com/jordibc/scipion-em-ucm.git /scipion/scipion-em-ucm
    /scipion/scipion3 installp -p /scipion/scipion-em-ucm --devel

    git clone -b apptainer https://github.com/I2PC/scipion-em-validation /scipion/scipion-em-validation
    /scipion/scipion3 pip install -r /scipion/scipion-em-validation/requirements.txt

    # Cleaning tasks for space optimisation
    apt clean
    apt autoclean
    apt autoremove
    rm -rf /var/lib/apt/lists/*
    unset DEBIAN_FRONTEND

%runscript